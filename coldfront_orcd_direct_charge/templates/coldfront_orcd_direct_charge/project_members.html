{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Project Members - {{ project.title }}
{% endblock %}

{% block content %}
<div class="mb-3">
  <h2><i class="fas fa-users"></i> Project Members</h2>
  <p class="text-muted">{{ project.title }}</p>
  <hr>
</div>

<div class="mb-3">
  <a href="{% url 'project-detail' project.pk %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Project
  </a>
  {% if can_manage_members %}
    <a href="{% url 'coldfront_orcd_direct_charge:project-add-users-search' project.pk %}" class="btn btn-success">
      <i class="fas fa-user-plus"></i> Add Member
    </a>
  {% endif %}
</div>

<div class="card">
  <div class="card-header">
    <h4 class="mb-0">Members ({{ members|length }})</h4>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Username</th>
            <th>Name</th>
            <th>Email</th>
            <th>Roles</th>
            <th>Account Maintenance</th>
            {% if can_manage_members %}
              <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for member in members %}
            <tr>
              <td>{{ member.user.username }}</td>
              <td>{{ member.user.first_name }} {{ member.user.last_name }}</td>
              <td>
                <a href="mailto:{{ member.user.email }}">{{ member.user.email }}</a>
              </td>
              <td>
                {% for role_info in member.roles_display %}
                  <span class="badge {{ role_info.badge_class }}">{{ role_info.name }}</span>
                {% empty %}
                  <span class="text-muted">No roles</span>
                {% endfor %}
              </td>
              <td>
                {% if member.maintenance_status_raw == 'inactive' %}
                  <span class="badge badge-light">{{ member.maintenance_status }}</span>
                {% elif member.maintenance_status_raw == 'basic' %}
                  <span class="badge badge-info">{{ member.maintenance_status }}</span>
                {% elif member.maintenance_status_raw == 'advanced' %}
                  <span class="badge badge-success">{{ member.maintenance_status }}</span>
                {% else %}
                  <span class="text-muted">{{ member.maintenance_status }}</span>
                {% endif %}
              </td>
              {% if can_manage_members %}
                <td>
                  {% if member.is_owner and member.roles|length == 1 %}
                    {# Owner with no additional roles - allow adding roles #}
                    <a href="{% url 'coldfront_orcd_direct_charge:update-member-role' project.pk member.user.pk %}" 
                       class="btn btn-sm btn-outline-primary" title="Manage Roles">
                      <i class="fas fa-edit"></i>
                    </a>
                  {% elif not member.is_owner %}
                    {% if 'financial_admin' in member.roles and not can_manage_financial_admins %}
                      <span class="text-muted">-</span>
                    {% else %}
                      <a href="{% url 'coldfront_orcd_direct_charge:update-member-role' project.pk member.user.pk %}" 
                         class="btn btn-sm btn-outline-primary" title="Manage Roles">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" 
                              data-toggle="modal" 
                              data-target="#removeMemberModal"
                              data-username="{{ member.user.username }}"
                              data-user-pk="{{ member.user.pk }}"
                              title="Remove Member">
                        <i class="fas fa-user-times"></i>
                      </button>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{% if can_manage_members %}6{% else %}5{% endif %}" class="text-center text-muted">
                No members found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Role Descriptions</h5>
  </div>
  <div class="card-body">
    <dl class="row mb-0">
      <dt class="col-sm-3"><span class="badge badge-primary">Owner</span></dt>
      <dd class="col-sm-9">Full control over the project. Can manage all members and settings. Included in reservations.</dd>
      
      <dt class="col-sm-3"><span class="badge badge-warning">Financial Admin</span></dt>
      <dd class="col-sm-9">Can edit cost allocations and manage all member roles. <strong>Not</strong> included in reservations or maintenance fee billing.</dd>
      
      <dt class="col-sm-3"><span class="badge badge-info">Technical Admin</span></dt>
      <dd class="col-sm-9">Can add members and technical admins. Included in reservations and can use project for maintenance fees.</dd>
      
      <dt class="col-sm-3"><span class="badge badge-secondary">Member</span></dt>
      <dd class="col-sm-9">Can create reservations. Included in reservations and can use project for maintenance fees.</dd>
    </dl>
  </div>
</div>

<!-- Remove Member Confirmation Modal -->
{% if can_manage_members %}
<div class="modal fade" id="removeMemberModal" tabindex="-1" role="dialog" aria-labelledby="removeMemberModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="removeMemberModalLabel">
          <i class="fas fa-user-times mr-2"></i> Confirm Member Removal
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="removeMemberForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Are you sure you want to remove <strong id="removeUsername"></strong> from this project?
          </div>
          <p class="text-muted">
            This will remove all their roles and access to this project. This action cannot be undone.
          </p>
          <div class="form-group">
            <label for="removalNotes">Notes <span class="text-muted">(optional)</span></label>
            <textarea class="form-control" id="removalNotes" name="notes" rows="3"
                      placeholder="Reason for removal..."></textarea>
            <small class="form-text text-muted">
              This note will be recorded in the activity log.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cancel
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-user-times mr-1"></i> Remove Member
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block javascript %}
{{ block.super }}
{% if can_manage_members %}
<script>
  $('#removeMemberModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var username = button.data('username');
    var userPk = button.data('user-pk');
    
    var modal = $(this);
    modal.find('#removeUsername').text(username);
    // Clear any previous notes
    modal.find('#removalNotes').val('');
    // Build the action URL
    var baseUrl = '{% url "coldfront_orcd_direct_charge:remove-member" project.pk 0 %}';
    modal.find('#removeMemberForm').attr('action', baseUrl.replace('/0/', '/' + userPk + '/'));
  });
</script>
{% endif %}
{% endblock %}


