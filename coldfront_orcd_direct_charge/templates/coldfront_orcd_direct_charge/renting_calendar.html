{% extends "common/base.html" %}
{% load static %}
{% load calendar_filters %}

{% block title %}Rent H200x8 GPU Nodes{% endblock %}

{% block content %}
<style>
.calendar-cell {
    position: relative;
    width: 35px;
    height: 30px;
}

/* Solid backgrounds for non-partial rentals */
.calendar-cell.not-bookable {
    background-color: #6c757d !important; /* Gray */
}

.calendar-cell.available {
    background-color: #28a745 !important; /* Green */
}

.calendar-cell.fully-rented {
    background-color: #dc3545 !important; /* Red */
}

/* Diagonal split for partial rentals */
.calendar-cell.am-only-rented {
    background: linear-gradient(135deg, #dc3545 0%, #dc3545 50%, #28a745 50%, #28a745 100%) !important;
}

.calendar-cell.pm-only-rented {
    background: linear-gradient(135deg, #28a745 0%, #28a745 50%, #dc3545 50%, #dc3545 100%) !important;
}

/* Icon positioning */
.calendar-cell .user-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 10px;
    z-index: 1;
    text-shadow: 0 0 2px rgba(0,0,0,0.5);
}
</style>
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="fas fa-calendar-alt"></i> H200x8 Rental Calendar</h2>
  <a href="{% url 'coldfront_orcd_direct_charge:reservation-request' %}" class="btn btn-primary">
    <i class="fas fa-plus"></i> Request Reservation
  </a>
</div>
<hr>

<!-- Month Navigation -->
<div class="d-flex justify-content-between align-items-center mb-4">
  {% if show_prev %}
  <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-outline-secondary">
    <i class="fas fa-chevron-left"></i> Previous
  </a>
  {% else %}
  <span class="btn btn-outline-secondary disabled" style="visibility: hidden;">
    <i class="fas fa-chevron-left"></i> Previous
  </span>
  {% endif %}
  <h3 class="mb-0">{{ month_name }} {{ year }}</h3>
  {% if show_next %}
  <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-outline-secondary">
    Next <i class="fas fa-chevron-right"></i>
  </a>
  {% else %}
  <span class="btn btn-outline-secondary disabled" title="Calendar limited to {{ max_month_name }} {{ max_year }}">
    Next <i class="fas fa-chevron-right"></i>
  </span>
  {% endif %}
</div>

<!-- Legend -->
<div class="mb-3">
  <span class="badge mr-2" style="background-color: #6c757d;">&nbsp;&nbsp;&nbsp;</span> Not Available
  <span class="badge badge-success ml-3 mr-2" style="background-color: #28a745;">&nbsp;&nbsp;&nbsp;</span> Available
  <span class="badge badge-danger ml-3 mr-2" style="background-color: #dc3545;">&nbsp;&nbsp;&nbsp;</span> Rented
  <span class="badge badge-danger ml-3 mr-2" style="background-color: #dc3545;"><i class="fas fa-user" style="color: white;"></i></span> My Rentals
</div>

<!-- Availability Calendar -->
<div class="table-responsive">
  <table class="table table-bordered table-sm" style="table-layout: fixed;">
    <thead class="thead-light">
      <tr>
        <th scope="col" style="width: 120px; position: sticky; left: 0; background: #f8f9fa; z-index: 1;">Node</th>
        {% for day in days %}
        <th scope="col" class="text-center" style="width: 35px; min-width: 35px;">
          {{ day }}
        </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for node in nodes %}
      <tr>
        <td style="position: sticky; left: 0; background: #fff; z-index: 1;">
          <code>{{ node.associated_resource_address }}</code>
        </td>
        {% for day in days %}
        {% with node_avail=availability|get_availability:node.id %}
        {% with info=node_avail|get_day_info:day %}
        <td class="calendar-cell text-center p-0 {% if info.is_bookable == False %}not-bookable{% elif info.rental_type == 'full' %}fully-rented{% elif info.rental_type == 'am_only' %}am-only-rented{% elif info.rental_type == 'pm_only' %}pm-only-rented{% elif info.rental_type == 'available' %}available{% else %}available{% endif %}">
          {% if info.am_is_mine or info.pm_is_mine %}
          <span class="user-icon">
            <i class="fas fa-user" title="My rental"></i>
          </span>
          {% endif %}
        </td>
        {% endwith %}
        {% endwith %}
        {% endfor %}
      </tr>
      {% empty %}
      <tr>
        <td colspan="{{ days|length|add:1 }}" class="text-muted text-center">
          No rentable H200x8 nodes available.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-4">
  <p class="text-muted">
    <strong>Reservation Rules:</strong>
    <ul>
      <li>Reservations must be made at least <strong>7 days in advance</strong> (earliest: {{ earliest_bookable|date:"M d, Y" }})</li>
      <li>Reservations start at <strong>4:00 PM</strong> on the start date</li>
      <li>Duration is in 12-hour blocks (minimum 12 hours)</li>
      <li>Reservations must end no later than <strong>9:00 AM</strong> on the final day</li>
      <li>Calendar available through <strong>{{ max_month_name }} {{ max_year }}</strong> (3 months ahead)</li>
    </ul>
  </p>
</div>

{% endblock %}
