{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Manage Roles - {{ target_user.username }}
{% endblock %}

{% block content %}
<div class="mb-3">
  <h2><i class="fas fa-user-edit"></i> Manage Member Roles</h2>
  <p class="text-muted">{{ project.title }}</p>
  <hr>
</div>

<div class="mb-3">
  <a href="{% url 'coldfront_orcd_direct_charge:project-members' project.pk %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Members
  </a>
</div>

<div class="card">
  <div class="card-header">
    <h4 class="mb-0">Manage Roles for {{ target_user.username }}</h4>
  </div>
  <div class="card-body">
    <div class="mb-4">
      <p><strong>User:</strong> {{ target_user.first_name }} {{ target_user.last_name }} ({{ target_user.username }})</p>
      <p><strong>Email:</strong> {{ target_user.email }}</p>
      {% if is_owner %}
        <p><strong>Owner:</strong> <span class="badge badge-primary">Yes</span> <small class="text-muted">(implicit, cannot be changed)</small></p>
      {% endif %}
      <p><strong>Current Roles:</strong> 
        {% if current_roles %}
          {% for role in current_roles %}
            {% if role == 'financial_admin' %}
              <span class="badge badge-warning">Financial Admin</span>
            {% elif role == 'technical_admin' %}
              <span class="badge badge-info">Technical Admin</span>
            {% elif role == 'member' %}
              <span class="badge badge-secondary">Member</span>
            {% endif %}
          {% endfor %}
        {% else %}
          <span class="text-muted">None (explicit roles only)</span>
        {% endif %}
      </p>
    </div>
    
    <form method="post">
      {% csrf_token %}
      
      <div class="form-group">
        <label>Roles</label>
        <div class="ml-2">
          {{ form.roles }}
        </div>
        {% if form.roles.errors %}
          <div class="invalid-feedback d-block">
            {{ form.roles.errors.0 }}
          </div>
        {% endif %}
        <small class="form-text text-muted">
          {{ form.roles.help_text }}
          {% if not is_owner %}
            <br><strong>Note:</strong> Unchecking all roles will remove this user from the project.
          {% endif %}
        </small>
      </div>
      
      <div class="mt-4">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Update Roles
        </button>
        <a href="{% url 'coldfront_orcd_direct_charge:project-members' project.pk %}" class="btn btn-secondary">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Role Descriptions</h5>
  </div>
  <div class="card-body">
    <dl class="row mb-0">
      {% if can_set_financial_admin %}
        <dt class="col-sm-3"><span class="badge badge-warning">Financial Admin</span></dt>
        <dd class="col-sm-9">Can edit cost allocations and manage all member roles. <strong>Not</strong> included in reservations.</dd>
      {% endif %}
      
      <dt class="col-sm-3"><span class="badge badge-info">Technical Admin</span></dt>
      <dd class="col-sm-9">Can add members and technical admins. Included in reservations.</dd>
      
      <dt class="col-sm-3"><span class="badge badge-secondary">Member</span></dt>
      <dd class="col-sm-9">Can create reservations. Included in reservations.</dd>
    </dl>
    <p class="mt-3 mb-0 text-muted small">
      <i class="fas fa-info-circle"></i> Users can have multiple roles. Permissions are cumulative.
    </p>
  </div>
</div>
{% endblock %}

