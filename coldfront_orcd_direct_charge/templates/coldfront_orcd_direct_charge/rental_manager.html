{% extends "common/base.html" %}
{% load static %}

{% block title %}Rental Manager{% endblock %}

{% block content %}
<h2><i class="fas fa-tasks"></i> Rental Manager Dashboard</h2>
<hr>

<!-- Pending Reservations -->
<div class="card mb-4">
  <div class="card-header bg-warning">
    <h5 class="mb-0"><i class="fas fa-clock"></i> Pending Reservation Requests ({{ pending_reservations|length }})</h5>
  </div>
  <div class="card-body">
    {% if pending_reservations %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="thead-light">
          <tr>
            <th>Node</th>
            <th>Project</th>
            <th>Requester</th>
            <th>Start</th>
            <th>Duration</th>
            <th>End</th>
            <th>Notes</th>
            <th>Submitted</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for reservation in pending_reservations %}
          <tr>
            <td><code>{{ reservation.node_instance.associated_resource_address }}</code></td>
            <td>{{ reservation.project.title }}</td>
            <td>{{ reservation.requesting_user.get_full_name|default:reservation.requesting_user.username }}</td>
            <td>{{ reservation.start_datetime|date:"M d, Y" }} @ 4:00 PM</td>
            <td>{{ reservation.billable_hours }} hours</td>
            <td>{{ reservation.end_datetime|date:"M d, Y g:i A" }}</td>
            <td>
              {% if reservation.rental_notes %}
              <span class="text-muted" title="{{ reservation.rental_notes }}">
                <i class="fas fa-sticky-note"></i> {{ reservation.rental_notes|truncatewords:5 }}
              </span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>{{ reservation.created|date:"M d, Y H:i" }}</td>
            <td>
              <form method="post" action="{% url 'coldfront_orcd_direct_charge:reservation-approve' reservation.pk %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success" title="Approve">
                  <i class="fas fa-check"></i> Approve
                </button>
              </form>
              <button type="button" class="btn btn-sm btn-danger" 
                      data-toggle="modal" 
                      data-target="#declineModal{{ reservation.pk }}"
                      title="Decline">
                <i class="fas fa-times"></i> Decline
              </button>
              <button type="button" class="btn btn-sm btn-secondary" 
                      data-toggle="modal" 
                      data-target="#metadataModal{{ reservation.pk }}"
                      title="Edit Metadata">
                <i class="fas fa-cog"></i>
              </button>

              <!-- Metadata Modal -->
              <div class="modal fade" id="metadataModal{{ reservation.pk }}" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Booking Management Metadata</h5>
                      <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                      </button>
                    </div>
                    <form method="post" action="{% url 'coldfront_orcd_direct_charge:reservation-metadata' reservation.pk %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <p>
                          <strong>Node:</strong> {{ reservation.node_instance.associated_resource_address }}<br>
                          <strong>Project:</strong> {{ reservation.project.title }}<br>
                          <strong>Dates:</strong> {{ reservation.start_datetime|date:"M d" }} - {{ reservation.end_datetime|date:"M d, Y" }}
                        </p>
                        {% if reservation.rental_notes %}
                        <div class="alert alert-info">
                          <strong>Requester Notes:</strong><br>
                          {{ reservation.rental_notes }}
                        </div>
                        {% endif %}

                        <!-- Existing Metadata Entries -->
                        {% if reservation.metadata_entries.all %}
                        <div class="mb-3">
                          <label><strong>Existing Metadata Entries</strong></label>
                          {% for entry in reservation.metadata_entries.all %}
                          <div class="card mb-2">
                            <div class="card-body py-2 px-3">
                              <small class="text-muted">{{ entry.created|date:"M d, Y H:i" }}</small>
                              <p class="mb-0">{{ entry.content }}</p>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}

                        <!-- New Entries Section -->
                        <div class="form-group">
                          <label><strong>Add New Entry</strong></label>
                          <div id="newEntriesContainer{{ reservation.pk }}">
                            <div class="entry-field mb-2">
                              <textarea name="new_entry_0" class="form-control" rows="2" 
                                        placeholder="Add a new metadata note..."></textarea>
                            </div>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-secondary mt-1" 
                                  onclick="addMetadataEntry({{ reservation.pk }})">
                            <i class="fas fa-plus"></i> Add Another Entry
                          </button>
                          <small class="form-text text-muted">This information is only visible to rental managers.</small>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save New Entries</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Decline Modal -->
              <div class="modal fade" id="declineModal{{ reservation.pk }}" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Decline Reservation</h5>
                      <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                      </button>
                    </div>
                    <form method="post" action="{% url 'coldfront_orcd_direct_charge:reservation-decline' reservation.pk %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <p>Are you sure you want to decline this reservation?</p>
                        <p>
                          <strong>Node:</strong> {{ reservation.node_instance.associated_resource_address }}<br>
                          <strong>Project:</strong> {{ reservation.project.title }}<br>
                          <strong>Dates:</strong> {{ reservation.start_datetime|date:"M d" }} - {{ reservation.end_datetime|date:"M d, Y" }}
                        </p>
                        <div class="form-group">
                          <label for="manager_notes">Notes (optional)</label>
                          <textarea name="manager_notes" class="form-control" rows="3" 
                                    placeholder="Provide a reason for declining (visible to requester)"></textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Decline Reservation</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted mb-0"><i class="fas fa-check-circle"></i> No pending reservation requests.</p>
    {% endif %}
  </div>
</div>

<!-- Recently Processed Reservations -->
<div class="card">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0"><i class="fas fa-history"></i> Recently Processed (Last 30 Days)</h5>
  </div>
  <div class="card-body">
    {% if recent_reservations %}
    <div class="table-responsive">
      <table class="table table-sm">
        <thead class="thead-light">
          <tr>
            <th>Node</th>
            <th>Project</th>
            <th>Requester</th>
            <th>Start</th>
            <th>Duration</th>
            <th>Notes</th>
            <th>Status</th>
            <th>Processed</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for reservation in recent_reservations %}
          <tr>
            <td><code>{{ reservation.node_instance.associated_resource_address }}</code></td>
            <td>{{ reservation.project.title }}</td>
            <td>{{ reservation.requesting_user.get_full_name|default:reservation.requesting_user.username }}</td>
            <td>{{ reservation.start_datetime|date:"M d, Y" }}</td>
            <td>{{ reservation.billable_hours }} hours</td>
            <td>
              {% if reservation.rental_notes %}
              <span class="text-muted" title="{{ reservation.rental_notes }}">
                <i class="fas fa-sticky-note"></i> {{ reservation.rental_notes|truncatewords:5 }}
              </span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if reservation.status == "APPROVED" %}
              <span class="badge badge-success">Approved</span>
              {% elif reservation.status == "DECLINED" %}
              <span class="badge badge-danger">Declined</span>
              {% endif %}
            </td>
            <td>{{ reservation.modified|date:"M d, Y H:i" }}</td>
            <td>
              <button type="button" class="btn btn-sm btn-secondary" 
                      data-toggle="modal" 
                      data-target="#metadataModalRecent{{ reservation.pk }}"
                      title="Edit Metadata">
                <i class="fas fa-cog"></i>
              </button>

              <!-- Metadata Modal for Recent -->
              <div class="modal fade" id="metadataModalRecent{{ reservation.pk }}" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Booking Management Metadata</h5>
                      <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                      </button>
                    </div>
                    <form method="post" action="{% url 'coldfront_orcd_direct_charge:reservation-metadata' reservation.pk %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <p>
                          <strong>Node:</strong> {{ reservation.node_instance.associated_resource_address }}<br>
                          <strong>Project:</strong> {{ reservation.project.title }}<br>
                          <strong>Dates:</strong> {{ reservation.start_datetime|date:"M d" }} - {{ reservation.end_datetime|date:"M d, Y" }}
                        </p>
                        {% if reservation.rental_notes %}
                        <div class="alert alert-info">
                          <strong>Requester Notes:</strong><br>
                          {{ reservation.rental_notes }}
                        </div>
                        {% endif %}

                        <!-- Existing Metadata Entries -->
                        {% if reservation.metadata_entries.all %}
                        <div class="mb-3">
                          <label><strong>Existing Metadata Entries</strong></label>
                          {% for entry in reservation.metadata_entries.all %}
                          <div class="card mb-2">
                            <div class="card-body py-2 px-3">
                              <small class="text-muted">{{ entry.created|date:"M d, Y H:i" }}</small>
                              <p class="mb-0">{{ entry.content }}</p>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}

                        <!-- New Entries Section -->
                        <div class="form-group">
                          <label><strong>Add New Entry</strong></label>
                          <div id="newEntriesContainerRecent{{ reservation.pk }}">
                            <div class="entry-field mb-2">
                              <textarea name="new_entry_0" class="form-control" rows="2" 
                                        placeholder="Add a new metadata note..."></textarea>
                            </div>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-secondary mt-1" 
                                  onclick="addMetadataEntryRecent({{ reservation.pk }})">
                            <i class="fas fa-plus"></i> Add Another Entry
                          </button>
                          <small class="form-text text-muted">This information is only visible to rental managers.</small>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save New Entries</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">No recently processed reservations.</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block javascript %}
<script>
// Track the number of entry fields for each reservation
var entryCounters = {};
var entryCountersRecent = {};

function addMetadataEntry(reservationPk) {
    if (!entryCounters[reservationPk]) {
        entryCounters[reservationPk] = 1;
    }
    var counter = entryCounters[reservationPk];
    entryCounters[reservationPk]++;

    var container = document.getElementById('newEntriesContainer' + reservationPk);
    var newField = document.createElement('div');
    newField.className = 'entry-field mb-2';
    newField.innerHTML = '<div class="d-flex">' +
        '<textarea name="new_entry_' + counter + '" class="form-control" rows="2" ' +
        'placeholder="Add a new metadata note..."></textarea>' +
        '<button type="button" class="btn btn-sm btn-outline-danger ml-2" ' +
        'onclick="this.parentElement.parentElement.remove()">' +
        '<i class="fas fa-times"></i></button>' +
        '</div>';
    container.appendChild(newField);
}

function addMetadataEntryRecent(reservationPk) {
    if (!entryCountersRecent[reservationPk]) {
        entryCountersRecent[reservationPk] = 1;
    }
    var counter = entryCountersRecent[reservationPk];
    entryCountersRecent[reservationPk]++;

    var container = document.getElementById('newEntriesContainerRecent' + reservationPk);
    var newField = document.createElement('div');
    newField.className = 'entry-field mb-2';
    newField.innerHTML = '<div class="d-flex">' +
        '<textarea name="new_entry_' + counter + '" class="form-control" rows="2" ' +
        'placeholder="Add a new metadata note..."></textarea>' +
        '<button type="button" class="btn btn-sm btn-outline-danger ml-2" ' +
        'onclick="this.parentElement.parentElement.remove()">' +
        '<i class="fas fa-times"></i></button>' +
        '</div>';
    container.appendChild(newField);
}
</script>
{% endblock %}
