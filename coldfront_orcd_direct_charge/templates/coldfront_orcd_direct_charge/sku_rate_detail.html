{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load rate_filters %}

{% block title %}
{{ sku.name }} - Rate History
{% endblock %}

{% block content %}
<div class="mb-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'coldfront_orcd_direct_charge:rate-management' %}">Rate Management</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">{{ sku.name }}</li>
    </ol>
  </nav>
</div>

<div class="row">
  <!-- SKU Details -->
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-tag"></i> SKU Details</h5>
      </div>
      <div class="card-body">
        <table class="table table-sm table-borderless">
          <tr>
            <th>SKU Code:</th>
            <td><code>{{ sku.sku_code }}</code></td>
          </tr>
          <tr>
            <th>Name:</th>
            <td>{{ sku.name }}</td>
          </tr>
          <tr>
            <th>Type:</th>
            <td>
              {% if sku.sku_type == 'NODE' %}
                <span class="badge badge-primary">Node Rental</span>
              {% elif sku.sku_type == 'MAINTENANCE' %}
                <span class="badge badge-success">Maintenance Fee</span>
              {% else %}
                <span class="badge badge-info">Rentable QoS</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>Billing:</th>
            <td>{{ sku.get_billing_unit_display }}</td>
          </tr>
          <tr>
            <th>Status:</th>
            <td>
              {% if sku.is_active %}
                <span class="badge badge-success">Active</span>
              {% else %}
                <span class="badge badge-secondary">Inactive</span>
              {% endif %}
            </td>
          </tr>
          {% if sku.linked_model %}
          <tr>
            <th>Linked To:</th>
            <td><code>{{ sku.linked_model }}</code></td>
          </tr>
          {% endif %}
          {% if sku.description %}
          <tr>
            <th>Description:</th>
            <td>{{ sku.description }}</td>
          </tr>
          {% endif %}
        </table>

        <hr>

        <h6>Current Rate</h6>
        {% if current_rate %}
          <div class="alert alert-info mb-0">
            <strong class="h4">${{ current_rate.rate|format_rate }}</strong>
            <span class="text-muted">/ {{ sku.get_billing_unit_display|lower }}</span>
            <br>
            <small>Effective since {{ current_rate.effective_date|date:"M d, Y" }}</small>
          </div>
        {% else %}
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle"></i> No rate currently set
          </div>
        {% endif %}

        <div class="mt-3">
          <a href="{% url 'coldfront_orcd_direct_charge:add-rate' sku.pk %}" 
             class="btn btn-primary btn-block">
            <i class="fas fa-plus"></i> Add New Rate
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Rate History -->
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-history"></i> Rate History
          <span class="badge badge-secondary ml-2">{{ rates|length }} rate{{ rates|length|pluralize }}</span>
        </h5>
      </div>
      <div class="card-body p-0">
        {% if rates %}
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th>Rate</th>
              <th>Effective Date</th>
              <th>Set By</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for rate in rates %}
            <tr {% if forloop.first %}class="table-active"{% endif %}>
              <td>
                <strong>${{ rate.rate|format_rate }}</strong>
                <span class="text-muted">/ {{ sku.get_billing_unit_display|lower }}</span>
                {% if forloop.first %}
                  <span class="badge badge-success ml-1">Current</span>
                {% endif %}
              </td>
              <td>{{ rate.effective_date|date:"M d, Y" }}</td>
              <td>
                {% if rate.set_by %}
                  {{ rate.set_by.username }}
                  {% if rate.set_by.first_name %}
                    <br><small class="text-muted">{{ rate.set_by.first_name }} {{ rate.set_by.last_name }}</small>
                  {% endif %}
                {% else %}
                  <span class="text-muted">System</span>
                {% endif %}
              </td>
              <td>
                {% if rate.notes %}
                  {{ rate.notes|truncatewords:20 }}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-4 text-muted text-center">
          <i class="fas fa-info-circle"></i> No rates have been set for this SKU yet.
          <br>
          <a href="{% url 'coldfront_orcd_direct_charge:add-rate' sku.pk %}" class="btn btn-primary mt-2">
            <i class="fas fa-plus"></i> Add First Rate
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="mt-4">
  <a href="{% url 'coldfront_orcd_direct_charge:rate-management' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Rate Management
  </a>
</div>
{% endblock %}

