{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load rate_filters %}

{% block title %}
Rate Management
{% endblock %}

{% block content %}
<div class="mb-3">
  <h2><i class="fas fa-dollar-sign"></i> Rate Management</h2>
  <p class="text-muted">
    Manage rental rates for nodes, account maintenance fees, and QoS
    <a href="{% url 'coldfront_orcd_direct_charge:current-rates' %}" class="btn btn-sm btn-outline-info ml-3">
      <i class="fas fa-eye"></i> View Public Rates Page
    </a>
  </p>
</div>

<style>
  /* Toggle switch styles */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 24px;
  }
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
  }
  input:checked + .toggle-slider {
    background-color: #28a745;
  }
  input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
  .toggle-switch.disabled .toggle-slider {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<!-- Node Rentals (Hourly) -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
      <i class="fas fa-microchip"></i> Node Rentals
      <span class="badge badge-light ml-2">Hourly Billing</span>
    </h5>
  </div>
  <div class="card-body p-0">
    {% if node_skus %}
    <table class="table table-hover mb-0">
      <thead class="thead-light">
        <tr>
          <th>SKU</th>
          <th>Name</th>
          <th>Current Rate</th>
          <th>Effective Date</th>
          <th class="text-center" title="Visible on public Current Rates page">Public</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in node_skus %}
        <tr>
          <td>
            <code>{{ item.sku.sku_code }}</code>
            {% if not item.sku.is_active %}
              <span class="badge badge-secondary">Inactive</span>
            {% endif %}
          </td>
          <td>{{ item.sku.name }}</td>
          <td>
            {% if item.current_rate %}
              <strong>${{ item.current_rate.rate|format_rate }}/hr</strong>
            {% else %}
              <span class="text-muted">No rate set</span>
            {% endif %}
          </td>
          <td>
            {% if item.current_rate %}
              {{ item.current_rate.effective_date|date:"M d, Y" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="text-center">
            <label class="toggle-switch mb-0" title="Toggle visibility on Current Rates page">
              <input type="checkbox" 
                     class="visibility-toggle" 
                     data-sku-id="{{ item.sku.pk }}"
                     {% if item.sku.is_public %}checked{% endif %}>
              <span class="toggle-slider"></span>
            </label>
          </td>
          <td>
            <a href="{% url 'coldfront_orcd_direct_charge:add-rate' item.sku.pk %}" 
               class="btn btn-sm btn-outline-primary">
              <i class="fas fa-plus"></i> Add Rate
            </a>
            <a href="{% url 'coldfront_orcd_direct_charge:sku-rate-detail' item.sku.pk %}" 
               class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-history"></i> History ({{ item.rate_count }})
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="p-4 text-muted text-center">
      <i class="fas fa-info-circle"></i> No node SKUs configured
    </div>
    {% endif %}
  </div>
</div>

<!-- Account Maintenance Fees (Monthly) -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0">
      <i class="fas fa-wrench"></i> Account Maintenance Fees
      <span class="badge badge-light ml-2">Monthly Billing</span>
    </h5>
  </div>
  <div class="card-body p-0">
    {% if maintenance_skus %}
    <table class="table table-hover mb-0">
      <thead class="thead-light">
        <tr>
          <th>SKU</th>
          <th>Name</th>
          <th>Current Rate</th>
          <th>Effective Date</th>
          <th class="text-center" title="Visible on public Current Rates page">Public</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in maintenance_skus %}
        <tr>
          <td>
            <code>{{ item.sku.sku_code }}</code>
            {% if not item.sku.is_active %}
              <span class="badge badge-secondary">Inactive</span>
            {% endif %}
          </td>
          <td>{{ item.sku.name }}</td>
          <td>
            {% if item.current_rate %}
              <strong>${{ item.current_rate.rate|format_rate }}/mo</strong>
            {% else %}
              <span class="text-muted">No rate set</span>
            {% endif %}
          </td>
          <td>
            {% if item.current_rate %}
              {{ item.current_rate.effective_date|date:"M d, Y" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="text-center">
            <label class="toggle-switch mb-0" title="Toggle visibility on Current Rates page">
              <input type="checkbox" 
                     class="visibility-toggle" 
                     data-sku-id="{{ item.sku.pk }}"
                     {% if item.sku.is_public %}checked{% endif %}>
              <span class="toggle-slider"></span>
            </label>
          </td>
          <td>
            <a href="{% url 'coldfront_orcd_direct_charge:add-rate' item.sku.pk %}" 
               class="btn btn-sm btn-outline-success">
              <i class="fas fa-plus"></i> Add Rate
            </a>
            <a href="{% url 'coldfront_orcd_direct_charge:sku-rate-detail' item.sku.pk %}" 
               class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-history"></i> History ({{ item.rate_count }})
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="p-4 text-muted text-center">
      <i class="fas fa-info-circle"></i> No account maintenance SKUs configured
    </div>
    {% endif %}
  </div>
</div>

<!-- Rentable QoS (Monthly) -->
<div class="card mb-4">
  <div class="card-header bg-info text-white">
    <h5 class="mb-0">
      <i class="fas fa-tachometer-alt"></i> Rentable QoS
      <span class="badge badge-light ml-2">Monthly Billing</span>
      <a href="{% url 'coldfront_orcd_direct_charge:create-sku' %}" 
         class="btn btn-sm btn-light float-right">
        <i class="fas fa-plus"></i> Add Custom QoS
      </a>
    </h5>
  </div>
  <div class="card-body p-0">
    {% if qos_skus %}
    <table class="table table-hover mb-0">
      <thead class="thead-light">
        <tr>
          <th>SKU</th>
          <th>Name</th>
          <th>Current Rate</th>
          <th>Effective Date</th>
          <th class="text-center" title="Visible on public Current Rates page">Public</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in qos_skus %}
        <tr>
          <td>
            <code>{{ item.sku.sku_code }}</code>
            {% if not item.sku.is_active %}
              <span class="badge badge-secondary">Inactive</span>
            {% endif %}
          </td>
          <td>{{ item.sku.name }}</td>
          <td>
            {% if item.current_rate %}
              <strong>${{ item.current_rate.rate|format_rate }}/mo</strong>
            {% else %}
              <span class="text-muted">No rate set</span>
            {% endif %}
          </td>
          <td>
            {% if item.current_rate %}
              {{ item.current_rate.effective_date|date:"M d, Y" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="text-center">
            <label class="toggle-switch mb-0" title="Toggle visibility on Current Rates page">
              <input type="checkbox" 
                     class="visibility-toggle" 
                     data-sku-id="{{ item.sku.pk }}"
                     {% if item.sku.is_public %}checked{% endif %}>
              <span class="toggle-slider"></span>
            </label>
          </td>
          <td>
            <a href="{% url 'coldfront_orcd_direct_charge:add-rate' item.sku.pk %}" 
               class="btn btn-sm btn-outline-info">
              <i class="fas fa-plus"></i> Add Rate
            </a>
            <a href="{% url 'coldfront_orcd_direct_charge:sku-rate-detail' item.sku.pk %}" 
               class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-history"></i> History ({{ item.rate_count }})
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="p-4 text-muted text-center">
      <i class="fas fa-info-circle"></i> No QoS SKUs configured. 
      <a href="{% url 'coldfront_orcd_direct_charge:create-sku' %}">Create one now</a>.
    </div>
    {% endif %}
  </div>
</div>

<!-- Hidden form for CSRF token -->
<form id="csrf-form" style="display: none;">{% csrf_token %}</form>

<div class="mt-4">
  <a href="{% url 'coldfront_orcd_direct_charge:node-instance-list' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
  </a>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle visibility toggle clicks
  document.querySelectorAll('.visibility-toggle').forEach(function(toggle) {
    toggle.addEventListener('change', function() {
      const skuId = this.dataset.skuId;
      const checkbox = this;
      const label = checkbox.closest('.toggle-switch');
      
      // Disable while processing
      label.classList.add('disabled');
      checkbox.disabled = true;
      
      // Get CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value 
        || document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
      
      const url = `{% url 'coldfront_orcd_direct_charge:toggle-sku-visibility' pk=0 %}`.replace('/0/', `/${skuId}/`);
      
      if (!csrfToken) {
        console.error('CSRF token not found');
        checkbox.checked = !checkbox.checked;
        alert('Error: CSRF token not found. Please refresh the page.');
        return;
      }
      
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        credentials: 'same-origin',
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          checkbox.checked = data.is_public;
          console.log(`SKU ${skuId} visibility set to ${data.is_public}`);
        } else {
          // Revert on failure
          checkbox.checked = !checkbox.checked;
          alert('Failed to update visibility: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error updating visibility:', error);
        checkbox.checked = !checkbox.checked;
        alert('Failed to update visibility: ' + error.message);
      })
      .finally(() => {
        label.classList.remove('disabled');
        checkbox.disabled = false;
      });
    });
  });
});
</script>
{% endblock %}

