{% extends "common/base.html" %}
{% load static %}
{% load project_roles %}

{% block title %}
User Profile{% if not user == viewed_user %}: {{ viewed_user.username }}{% endif %}
{% endblock %}

{% block content %}
<h2>User Profile</h2>
<hr>

<div class="card">
  <div class="card-header">
    <i class="fas fa-user" aria-hidden="true"></i>
    {{ viewed_user.username }}
    <div class="float-right">
      <a class="btn btn-info" href="{% url 'user-projects-managers' viewed_user %}" role="button"><i class="far fa-user-circle" aria-hidden="true"></i> View user projects and managers</a>
    </div>
  </div>
  <div class="card-body">
    <div class="card-title text-center h4">
      {{viewed_user.first_name}} {{viewed_user.last_name}}
    </div>
    <div class="table-responsive">
      <table class="table">
        <tbody>
          {% block profile_contents %}
            <tr>
              <th scope="row" nowrap>Role(s):</th>
              <td>{{group_list}}</td>
            </tr>
            <tr>
              <th scope="row">Email:</th>
              <td>{{viewed_user.email}}</td>
            </tr>
            {% if not settings.AUTO_PI_ENABLE %}
            <tr>
              <th scope="row">PI Status:</th>
              <td>
                {% if viewed_user.userprofile.is_pi %}
                  <span class="badge badge-success"><i class="fas fa-check" aria-hidden="true"></i><span class="sr-only">Yes</span></span>
                {% elif not user == viewed_user %}
                  <span class="badge badge-danger"><i class="fas fa-times" aria-hidden="true"></i><span class="sr-only">No</span></span>
                {% else %}
                  <form class="form-inline" method="post" action="{% url 'user-upgrade' %}">
                    <div class="form-group mb-2">
                      <span class="badge badge-danger"><i class="fas fa-times" aria-hidden="true"></i><span class="sr-only">No</span></span>
                    </div>
                    <div class="form-group mx-sm-3 mb-2">
                      {% csrf_token %}
                      <button class="btn btn-secondary" type="submit"><i class="fas fa-chevron-circle-up" aria-hidden="true"></i> Upgrade Account</button>
                    </div>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% endif %}
            <tr>
              <th scope="row">Account Maintenance Fee Status:</th>
              <td>
                <span id="maintenance-status-display">
                  {% if viewed_user.maintenance_status %}
                    {{ viewed_user.maintenance_status.get_status_display }}{% if viewed_user.maintenance_status.billing_project %} (project charged: <a href="{% url 'project-detail' viewed_user.maintenance_status.billing_project.pk %}">{{ viewed_user.maintenance_status.billing_project.title }}</a>){% endif %}{% if viewed_user.maintenance_status.end_date and viewed_user.maintenance_status.end_date.year < 2100 %} <span class="text-muted">(ends: {{ viewed_user.maintenance_status.end_date }})</span>{% endif %}
                  {% else %}
                    Inactive
                  {% endif %}
                </span>
                {% if user == viewed_user %}
                  <a href="#" data-toggle="modal" data-target="#maintenanceStatusModal" title="Edit Account Maintenance Fee Status">
                    <i class="fas fa-edit" aria-hidden="true"></i>
                    <span class="sr-only">Edit Account Maintenance Fee Status</span>
                  </a>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">Last Login:</th>
              <td>{{viewed_user.last_login}}</td>
            </tr>
            {% if user == viewed_user %}
            <tr>
              <th scope="row">API Token:</th>
              <td>
                {% if request.user.auth_token.key %}
                  <code id="api-token" data-full-token="{{ request.user.auth_token.key }}">
                    •••••••{{ request.user.auth_token.key|slice:"-6:" }}
                  </code>
                {% else %}
                  <code id="api-token">None</code>
                {% endif %}
                <br><br>
                <button class="btn btn-secondary btn-sm" id="copy-token-btn" {% if not request.user.auth_token.key %}disabled{% endif %}>
                  <i class="fas fa-copy"></i> Copy
                </button>
                <button class="btn btn-danger btn-sm" id="regenerate-token-btn">
                  <i class="fas fa-sync-alt"></i> Regenerate Token
                </button>
              </td>
            </tr>
            {% endif %}
          {% endblock %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Account Maintenance Status Modal -->
{% if user == viewed_user %}
{% get_projects_for_maintenance_fee user as eligible_projects %}
<div class="modal fade" id="maintenanceStatusModal" tabindex="-1" role="dialog" aria-labelledby="maintenanceStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="maintenanceStatusModalLabel">Edit Account Maintenance Fee Status</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="maintenanceStatusForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="maintenanceStatusSelect">Account Maintenance Fee Status</label>
            <select class="form-control" id="maintenanceStatusSelect" name="status">
              <option value="inactive" {% if viewed_user.maintenance_status.status == 'inactive' or not viewed_user.maintenance_status %}selected{% endif %}>Inactive</option>
              <option value="basic" {% if viewed_user.maintenance_status.status == 'basic' %}selected{% endif %}>Basic</option>
              <option value="advanced" {% if viewed_user.maintenance_status.status == 'advanced' %}selected{% endif %}>Advanced</option>
            </select>
          </div>
          <div class="form-group" id="billingProjectGroup" style="display: none;">
            <label for="billingProjectSelect">Billing Project <span class="text-danger">*</span></label>
            <select class="form-control" id="billingProjectSelect" name="project_id">
              <option value="">-- Select a project --</option>
              {% for project in eligible_projects %}
                <option value="{{ project.pk }}" {% if viewed_user.maintenance_status.billing_project.pk == project.pk %}selected{% endif %}>{{ project.title }}</option>
              {% endfor %}
            </select>
            {% if eligible_projects %}
              <small class="form-text text-muted">
                Only projects with approved cost allocations are shown.
              </small>
            {% else %}
              <small class="form-text text-danger">
                <i class="fas fa-exclamation-triangle"></i>
                No eligible projects. Projects must have an approved cost allocation.
              </small>
            {% endif %}
          </div>
          <div class="form-group" id="endDateGroup" style="display: none;">
            <label for="endDateInput">End Date <small class="text-muted">(optional)</small></label>
            <input type="date" class="form-control" id="endDateInput" name="end_date"
                   value="{% if viewed_user.maintenance_status.end_date and viewed_user.maintenance_status.end_date.year < 2100 %}{{ viewed_user.maintenance_status.end_date|date:'Y-m-d' }}{% endif %}">
            <small class="form-text text-muted">
              Leave blank for indefinite billing. Set a date to stop billing after that date.
            </small>
          </div>
        </form>
        <div id="maintenanceStatusAlert" class="alert" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveMaintenanceStatus">Save</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  $("#navbar-main > ul > li.active").removeClass("active");
  $("#navbar-user").addClass("active");
  $("#navbar-user-user-profile").addClass("active");

  {% if user == viewed_user %}
  $(document).ready(function() {
    // Function to toggle billing project and end date visibility
    function toggleBillingProject() {
      var status = $("#maintenanceStatusSelect").val();
      if (status === "inactive") {
        $("#billingProjectGroup").hide();
        $("#billingProjectSelect").val("");  // Clear selection
        $("#endDateGroup").hide();
        $("#endDateInput").val("");  // Clear end date
      } else {
        $("#billingProjectGroup").show();
        $("#endDateGroup").show();
      }
    }

    // Initial toggle on page load
    toggleBillingProject();

    // Toggle on status change
    $("#maintenanceStatusSelect").change(function() {
      toggleBillingProject();
      // Hide any previous alerts when changing status
      $("#maintenanceStatusAlert").hide();
    });

    // Handle form submission
    $("#saveMaintenanceStatus").click(function() {
      var status = $("#maintenanceStatusSelect").val();
      var projectId = $("#billingProjectSelect").val();

      // Client-side validation for project selection
      if (status !== "inactive" && !projectId) {
        $("#maintenanceStatusAlert")
          .removeClass("alert-success")
          .addClass("alert-danger")
          .text("Please select a project for fee billing")
          .show();
        return;
      }

      var formData = $("#maintenanceStatusForm").serialize();
      
      $.ajax({
        url: "{% url 'coldfront_orcd_direct_charge:update-maintenance-status' %}",
        type: "POST",
        data: formData,
        success: function(response) {
          if (response.success) {
            // Update the display value with HTML (includes link to project and end date)
            var displayHtml = response.display;
            if (response.project_id && response.project_title) {
              var projectUrl = "{% url 'project-detail' 0 %}".replace("0", response.project_id);
              displayHtml += ' (project charged: <a href="' + projectUrl + '">' + response.project_title + '</a>)';
            }
            if (response.end_date && response.end_date.substring(0, 4) !== "2100") {
              displayHtml += ' <span class="text-muted">(ends: ' + response.end_date + ')</span>';
            }
            $("#maintenance-status-display").html(displayHtml);
            // Close the modal
            $("#maintenanceStatusModal").modal("hide");
            // Reset alert
            $("#maintenanceStatusAlert").hide();
          } else {
            $("#maintenanceStatusAlert")
              .removeClass("alert-success")
              .addClass("alert-danger")
              .text(response.error || "An error occurred.")
              .show();
          }
        },
        error: function(xhr) {
          var errorMsg = "An error occurred.";
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
          }
          $("#maintenanceStatusAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text(errorMsg)
            .show();
        }
      });
    });

    // Reset alert and toggle on modal open
    $("#maintenanceStatusModal").on("show.bs.modal", function() {
      $("#maintenanceStatusAlert").hide();
      toggleBillingProject();
    });

    // API Token - Copy to clipboard
    $("#copy-token-btn").click(async function() {
      var tokenElement = document.getElementById("api-token");
      var fullToken = tokenElement.dataset.fullToken;
      
      if (!fullToken) {
        return;
      }
      
      try {
        await navigator.clipboard.writeText(fullToken);
        
        // Visual feedback
        var btn = $(this);
        var originalHtml = btn.html();
        btn.html('<i class="fas fa-check"></i> Copied!');
        btn.removeClass('btn-secondary').addClass('btn-success');
        
        setTimeout(function() {
          btn.html(originalHtml);
          btn.removeClass('btn-success').addClass('btn-secondary');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy token:', err);
        alert('Failed to copy token to clipboard');
      }
    });

    // API Token - Regenerate
    $("#regenerate-token-btn").click(async function() {
      var confirmed = confirm(
        "Warning: Regenerating your token will immediately invalidate your existing token. " +
        "Any applications or scripts using the current token will stop working and will need to be updated. " +
        "The old token cannot be retrieved. Are you sure you want to continue?"
      );

      if (!confirmed) {
        return;
      }

      var btn = $(this);
      btn.prop('disabled', true);

      try {
        var response = await fetch('{% url "regenerate_token" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }

        var data = await response.json();
        
        // Update token display with masked version
        var tokenCode = document.getElementById('api-token');
        tokenCode.dataset.fullToken = data.token;
        tokenCode.textContent = '•••••••' + data.token.slice(-6);
        
        // Enable copy button if it was disabled
        $("#copy-token-btn").prop('disabled', false);
        
        // Visual feedback
        btn.html('<i class="fas fa-check"></i> Regenerated!');
        btn.removeClass('btn-danger').addClass('btn-success');
        
        setTimeout(function() {
          btn.html('<i class="fas fa-sync-alt"></i> Regenerate Token');
          btn.removeClass('btn-success').addClass('btn-danger');
        }, 2000);
        
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to regenerate token. Please try again.');
      } finally {
        btn.prop('disabled', false);
      }
    });
  });
  {% endif %}
</script>
{% endblock %}
