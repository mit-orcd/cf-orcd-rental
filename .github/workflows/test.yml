# GitHub Actions Workflow for Testing
#
# This workflow runs the plugin test suite against a fresh ColdFront installation.
# Currently configured for manual dispatch only (workflow_dispatch).
#
# To run:
# 1. Go to Actions tab in GitHub
# 2. Select "Tests" workflow
# 3. Click "Run workflow"
# 4. Choose runner type and click "Run workflow"
#

name: Tests

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - ubuntu-22.04
          - macos-latest
          - macos-14
          - self-hosted

env:
  COLDFRONT_VERSION: "1.1.7"
  SERVER_PORT: "8000"

jobs:
  test:
    name: Run Tests
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    
    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v4
        with:
          path: coldfront-orcd-direct-charge

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Setup Environment
        run: |
          cd coldfront-orcd-direct-charge
          ./tests/setup/setup_environment.sh
        env:
          RUNNER_TYPE: github
          WORKSPACE: ${{ github.workspace }}
          USE_UV: "true"

      - name: Run Tests
        run: |
          cd coldfront-orcd-direct-charge
          ./tests/run_all_tests.sh

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: /tmp/coldfront_server.log
          retention-days: 7

  # Optional: Test on multiple Python versions
  test-python-versions:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v4
        with:
          path: coldfront-orcd-direct-charge

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Setup Environment
        run: |
          cd coldfront-orcd-direct-charge
          ./tests/setup/setup_environment.sh
        env:
          RUNNER_TYPE: github
          WORKSPACE: ${{ github.workspace }}
          USE_UV: "true"

      - name: Run Tests
        run: |
          cd coldfront-orcd-direct-charge
          ./tests/run_all_tests.sh

      - name: Upload Server Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs-py${{ matrix.python-version }}
          path: /tmp/coldfront_server.log
          retention-days: 7

